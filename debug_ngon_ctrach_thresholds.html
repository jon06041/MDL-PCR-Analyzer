<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Ngon & Ctrach Thresholds</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #060; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Debug Ngon & Ctrach Threshold Issues</h1>
    
    <div class="test-section">
        <h2>1. Test Pathogen Library Configuration</h2>
        <div id="pathogen-library-test"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test Fixed Thresholds Configuration</h2>
        <div id="fixed-thresholds-test"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test Pattern Extraction</h2>
        <div id="pattern-extraction-test"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Test Threshold Calculation</h2>
        <div id="threshold-calculation-test"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Test Complete Threshold Flow</h2>
        <div id="complete-flow-test"></div>
    </div>

    <!-- Load required scripts -->
    <script src="static/pathogen_library.js"></script>
    <script src="static/threshold_strategies.js"></script>
    <script src="static/script.js"></script>
    
    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            element.appendChild(div);
        }

        function testPathogenLibrary() {
            log('pathogen-library-test', '<h3>Testing Pathogen Library</h3>');
            
            // Test Ngon
            if (window.PATHOGEN_LIBRARY && window.PATHOGEN_LIBRARY.Ngon) {
                const ngonChannels = Object.keys(window.PATHOGEN_LIBRARY.Ngon);
                log('pathogen-library-test', `✅ Ngon found in pathogen library with channels: ${ngonChannels.join(', ')}`, 'success');
                log('pathogen-library-test', `<pre>Ngon config: ${JSON.stringify(window.PATHOGEN_LIBRARY.Ngon, null, 2)}</pre>`);
            } else {
                log('pathogen-library-test', '❌ Ngon NOT found in pathogen library', 'error');
            }
            
            // Test Ctrach
            if (window.PATHOGEN_LIBRARY && window.PATHOGEN_LIBRARY.Ctrach) {
                const ctrachChannels = Object.keys(window.PATHOGEN_LIBRARY.Ctrach);
                log('pathogen-library-test', `✅ Ctrach found in pathogen library with channels: ${ctrachChannels.join(', ')}`, 'success');
                log('pathogen-library-test', `<pre>Ctrach config: ${JSON.stringify(window.PATHOGEN_LIBRARY.Ctrach, null, 2)}</pre>`);
            } else {
                log('pathogen-library-test', '❌ Ctrach NOT found in pathogen library', 'error');
            }
        }

        function testFixedThresholds() {
            log('fixed-thresholds-test', '<h3>Testing Fixed Thresholds</h3>');
            
            // Test Ngon
            if (window.PATHOGEN_FIXED_THRESHOLDS && window.PATHOGEN_FIXED_THRESHOLDS.Ngon) {
                const ngonChannels = Object.keys(window.PATHOGEN_FIXED_THRESHOLDS.Ngon);
                log('fixed-thresholds-test', `✅ Ngon found in fixed thresholds with channels: ${ngonChannels.join(', ')}`, 'success');
                log('fixed-thresholds-test', `<pre>Ngon thresholds: ${JSON.stringify(window.PATHOGEN_FIXED_THRESHOLDS.Ngon, null, 2)}</pre>`);
            } else {
                log('fixed-thresholds-test', '❌ Ngon NOT found in fixed thresholds', 'error');
            }
            
            // Test Ctrach
            if (window.PATHOGEN_FIXED_THRESHOLDS && window.PATHOGEN_FIXED_THRESHOLDS.Ctrach) {
                const ctrachChannels = Object.keys(window.PATHOGEN_FIXED_THRESHOLDS.Ctrach);
                log('fixed-thresholds-test', `✅ Ctrach found in fixed thresholds with channels: ${ctrachChannels.join(', ')}`, 'success');
                log('fixed-thresholds-test', `<pre>Ctrach thresholds: ${JSON.stringify(window.PATHOGEN_FIXED_THRESHOLDS.Ctrach, null, 2)}</pre>`);
            } else {
                log('fixed-thresholds-test', '❌ Ctrach NOT found in fixed thresholds', 'error');
            }
        }

        function testPatternExtraction() {
            log('pattern-extraction-test', '<h3>Testing Pattern Extraction</h3>');
            
            const testPatterns = [
                'Ngon_HEX_2024_12_27_Sample_1',
                'Ctrach_FAM_2024_12_27_Sample_1',
                'Ngon-HEX-2024-12-27-Sample-1',
                'Ctrach-FAM-2024-12-27-Sample-1'
            ];
            
            testPatterns.forEach(pattern => {
                try {
                    const testCode = extractTestCode(pattern);
                    log('pattern-extraction-test', `Pattern: "${pattern}" → Test Code: "${testCode}"`, testCode ? 'success' : 'error');
                } catch (error) {
                    log('pattern-extraction-test', `Pattern: "${pattern}" → Error: ${error.message}`, 'error');
                }
            });
        }

        function testThresholdCalculation() {
            log('threshold-calculation-test', '<h3>Testing Threshold Calculation</h3>');
            
            // Mock well data for testing
            const testWells = [
                {
                    well_id: 'A1',
                    channel: 'HEX',
                    pathogen: 'Ngon',
                    amplitude: 500,
                    baseline: 100
                },
                {
                    well_id: 'A2',
                    channel: 'FAM',
                    pathogen: 'Ctrach',
                    amplitude: 400,
                    baseline: 80
                }
            ];
            
            testWells.forEach(wellData => {
                try {
                    // Test if getPathogenThreshold function exists
                    if (typeof getPathogenThreshold === 'function') {
                        const threshold = getPathogenThreshold(wellData.pathogen, wellData.channel);
                        log('threshold-calculation-test', 
                            `${wellData.pathogen}/${wellData.channel} → Threshold: ${threshold}`, 
                            threshold ? 'success' : 'error');
                    } else {
                        log('threshold-calculation-test', '❌ getPathogenThreshold function not found', 'error');
                    }
                } catch (error) {
                    log('threshold-calculation-test', 
                        `${wellData.pathogen}/${wellData.channel} → Error: ${error.message}`, 'error');
                }
            });
        }

        function testCompleteFlow() {
            log('complete-flow-test', '<h3>Testing Complete Threshold Flow</h3>');
            
            // Simulate the complete threshold determination process
            const testScenarios = [
                {
                    filename: 'Ngon_HEX_2024_12_27_test.csv',
                    wellData: {
                        well_id: 'A1',
                        channel: 'HEX',
                        amplitude: 500,
                        baseline: 100
                    }
                },
                {
                    filename: 'Ctrach_FAM_2024_12_27_test.csv',
                    wellData: {
                        well_id: 'A2',
                        channel: 'FAM',
                        amplitude: 400,
                        baseline: 80
                    }
                }
            ];
            
            testScenarios.forEach(scenario => {
                log('complete-flow-test', `<h4>Testing: ${scenario.filename}</h4>`);
                
                // Step 1: Extract test code
                const testCode = extractTestCode(scenario.filename);
                log('complete-flow-test', `Step 1 - Test Code: "${testCode}"`);
                
                // Step 2: Get pathogen from test code + channel
                if (typeof getPathogenTarget === 'function') {
                    const pathogen = getPathogenTarget(testCode, scenario.wellData.channel);
                    log('complete-flow-test', `Step 2 - Pathogen: "${pathogen}"`);
                    
                    // Step 3: Get fixed threshold
                    if (window.PATHOGEN_FIXED_THRESHOLDS && window.PATHOGEN_FIXED_THRESHOLDS[pathogen]) {
                        const pathogenThresholds = window.PATHOGEN_FIXED_THRESHOLDS[pathogen];
                        const channelThreshold = pathogenThresholds[scenario.wellData.channel];
                        log('complete-flow-test', 
                            `Step 3 - Fixed Threshold: ${channelThreshold ? JSON.stringify(channelThreshold) : 'NOT FOUND'}`,
                            channelThreshold ? 'success' : 'error');
                    } else {
                        log('complete-flow-test', `Step 3 - No fixed threshold for pathogen: "${pathogen}"`, 'error');
                    }
                } else {
                    log('complete-flow-test', 'Step 2 - getPathogenTarget function not found', 'error');
                }
            });
        }

        // Run all tests when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                testPathogenLibrary();
                testFixedThresholds();
                testPatternExtraction();
                testThresholdCalculation();
                testCompleteFlow();
            }, 500);
        });
    </script>
</body>
</html>
