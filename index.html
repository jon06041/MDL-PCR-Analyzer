<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDL PCR Analyzer - Enhanced</title>
    <!-- Add favicon or logo -->
    <link rel="icon" type="image/png" href="/static/images/logo.png">
    <script src="/static/pathogen_library.js?v=1754415484"></script>
    <script src="static/formatNumber.js"></script>
    <!-- Load concentration controls for H/M/L CalcJ calculations -->
    <script src="/static/concentration_controls.js"></script>
    <!-- Load centralized configuration manager -->
    <script src="/static/config_manager.js"></script>
    <!-- Chart.js v4.x (stable) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Ensure threshold_strategies.js is loaded BEFORE script.js -->
    <script src="/static/threshold_strategies.js?v=1754415484"></script>
    <!-- Load CQJ/CalcJ utilities -->
    <script src="/static/cqj_calcj_utils.js"></script>
    <!-- Load frontend threshold logic BEFORE main script.js -->
    <script src="/static/threshold_frontend.js"></script>
    <!-- Chart.js Annotation Plugin v3.1.2 (compatible with Chart.js v4) -->
    <!-- <script src="/static/chartjs-plugin-annotation.min.js"></script>-->
    <!-- Diagnostics: Check Chart.js and Annotation plugin presence before main script -->
    <script>
      console.log('[DIAG] Before static/script.js:', {
        Chart: typeof window.Chart,
        ChartAnnotation: typeof window.ChartAnnotation,
        ChartPluginAnnotation: typeof window['chartjs-plugin-annotation'],
        ChartPlugins: window.Chart && window.Chart.registry ? Object.keys(window.Chart.registry.plugins) : 'N/A',
        LinearStrategies: typeof window.LINEAR_THRESHOLD_STRATEGIES,
        LogStrategies: typeof window.LOG_THRESHOLD_STRATEGIES
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>
    <!-- Load pathogen library BEFORE script.js to ensure getRequiredChannels is available -->
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="/static/style.css?v=1754415484">
    <link rel="stylesheet" href="/static/results-table-custom.css?v=1754415484">
    <link rel="stylesheet" href="/static/folder_queue.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- Optional: Add a logo/image here -->
            <!-- <img src="/static/images/your-logo.png" alt="Company Logo" style="height: 50px; margin-bottom: 10px;"> -->
            <h1>üß¨ MDL PCR Analyzer</h1>
            <p>Upload your CFX Manager CSV file to analyze amplification curves with flexible cycle counts</p>
            <div class="features">
                <span class="feature">‚úì Variable Cycle Lengths</span>
                <span class="feature">‚úì Dynamic Curve Fitting</span>
                <span class="feature">‚úì Real-time Analysis</span>
                <a href="/unified-compliance-dashboard" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; margin-left: 20px; font-weight: bold;">üìä Validation & Compliance Dashboard</a>
                <a href="/backup-manager" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; margin-left: 10px; font-weight: bold;">üóÑÔ∏è Database Backups</a>
                <button class="emergency-reset-btn" onclick="emergencyReset()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px; font-weight: bold;">üîÑ RESET EVERYTHING</button>
            </div>
        </div>

        <div class="upload-section">
            <div class="instructions-box">
                <h3>üìã Upload Instructions</h3>
                <!-- Optional: Add workflow diagram -->
                <!-- <img src="/static/images/workflow-diagram.png" alt="Analysis Workflow" style="width: 100%; max-width: 400px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;"> -->
                <p><strong>CFX Manager Export:</strong> Open .pcrd ‚Üí Quantification tab ‚Üí Export All Data Sheets ‚Üí CSV Format</p>
                <p><strong>Multi-Channel Support:</strong> Upload multiple "Quantification Amplification Results" CSV files - one for each fluorophore (Cy5, FAM, HEX, Texas Red) with pattern: testName_1234567_CFX123456.csv</p>
                <p><strong>Cycle Threshold Comparison:</strong> Upload the "Quantification Summary" CSV file for cycle threshold comparison (Required) - system automatically matches wells and fluorophores to display correct sample names and Cq values</p>
                <p><strong>Smart Analysis:</strong> System analyzes all uploaded fluorophores simultaneously for comprehensive multi-channel results</p>
            </div>
            
            <div class="file-upload-multi" id="fileUpload">
                <div class="upload-icon">üìÅ</div>
                <h3>Upload qPCR Data Files</h3>
                <p>Upload amplification data and optionally integrate Cq values and sample names</p>
                
                <!-- File Queue Button -->
                <a href="/queue.html" class="btn btn-outline-primary folder-queue-btn">
                    <i class="fas fa-layer-group"></i>
                    <span class="btn-text">File Queue</span>
                    <span class="queue-count" id="queueCount" style="display: none;">0</span>
                </a>
                
                <div class="file-upload-grid">
                    <div class="upload-item primary">
                        <h4>1. Amplification Data (Required)</h4>
                        <p>Upload one or more fluorophore-specific CSV files (Cy5, FAM, HEX, Texas Red)</p>
                        <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            Choose matching Amplification CSV Files
                        </button>
                        <button class="clear-btn" onclick="clearAmplificationFiles()">Clear Files</button>
                        <div class="file-status" id="amplificationStatus"></div>
                        <div class="uploaded-files" id="uploadedFiles"></div>
                    </div>
                    
                    <div class="upload-item required">
                        <h4>2. Quantification Summary (Required)</h4>
                        <p>Upload the Summary CSV file - provides sample names and Cq values for analysis</p>
                        <input type="file" id="samplesInput" class="file-input" accept=".csv">
                        <button class="upload-btn" onclick="document.getElementById('samplesInput').click()">
                            Choose a matching Quantification Summary
                        </button>
                        <button class="clear-btn" onclick="clearSummaryFile()">Clear File</button>
                        <div class="file-status" id="samplesStatus"></div>
                    </div>
                </div>
            </div>
            
            <div class="file-info" id="fileInfo" style="display: none;">
                <div class="file-details">
                    <strong>File:</strong> <span id="fileName"></span><br>
                    <strong>Size:</strong> <span id="fileSize"></span><br>
                    <strong>Cycles Detected:</strong> <span id="cycleRange"></span><br>
                    <strong>Wells Found:</strong> <span id="wellCount"></span>
                </div>
                <button class="analyze-btn" id="analyzeBtn">Analyze Curves</button>
            </div>
        </div>

        <div class="analysis-section" id="analysisSection" style="display: none;">
            <div class="controls">
                <div class="fluorophore-selector">
                    <label for="fluorophoreSelect">Select Fluorophore:</label>
                    <select id="fluorophoreSelect">
                        <option value="all">All Fluorophores</option>
                    </select>
                </div>
                <div class="well-selector">
                    <label for="wellSelect">Select Well:</label>
                    <select id="wellSelect"></select>
                </div>
                <div class="view-controls">
                    <button class="control-btn" id="showSelectedBtn">Show Selected Curve</button>
                    <button class="control-btn" id="showAllBtn">Show All Wells</button>
                    <button class="control-btn pos-btn" id="showPosBtn">POS</button>
                    <button class="control-btn neg-btn" id="showNegBtn">NEG</button>
                    <button class="control-btn redo-btn" id="showRedoBtn">REDO</button>
                    <button class="control-btn" id="exportBtn">Export Results</button>
                </div>
                <div class="edge-case-controls" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e0e0e0;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <span style="font-weight: 600; color: #495057;">Edge Cases:</span>
                        <span class="badge" style="background: #ffc107; color: #212529; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                            <span id="edgeCaseCounter" style="display: none;">0</span>
                            <span id="edgeCaseCounterText">0 detected</span>
                        </span>
                        <button 
                            id="mlBatchAnalysisBtn" 
                            class="control-btn" 
                            style="background: #6f42c1; color: white; font-size: 0.85rem; padding: 6px 12px;"
                            onclick="triggerMLBatchAnalysisForEdgeCases()"
                            disabled>
                            No Edge Cases to Analyze
                        </button>
                        <small style="color: #6c757d; font-style: italic;">
                            Edge cases are borderline samples that benefit from ML analysis
                        </small>
                    </div>
                </div>
            </div>

            <div class="chart-container" style="position: relative;">
                <select id="thresholdStrategySelect" style="position: absolute; top: 10px; right: 10px; z-index: 10; min-width: 220px; padding: 4px 8px; font-size: 14px; border-radius: 4px; border: 1px solid #bbb; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
                  <!-- Options will be populated by JS -->
                </select>
                <canvas id="amplificationChart"></canvas>
            </div>

            <div class="chart-post-controls">
            <div class="chart-controls-content">
                <!-- All controls in single row below chart -->
                <div class="controls-row-1">
                    <div class="scale-mode">
                        <label for="scaleToggle">Y-Axis:</label>
                        <button class="toggle-btn" id="scaleToggle" data-scale="linear">
                            <span class="toggle-option active">Linear</span>
                            <span class="toggle-option">Log</span>
                        </button>
                    </div>
                    <div class="threshold-manual" id="thresholdManualContainer" style="display: flex; align-items: center; gap: 6px; margin-right: 10px;">
                        <label for="thresholdInput" style="margin-bottom:0;">Threshold:</label>
                        <input type="number" id="thresholdInput" min="0" step="0.1" style="width: 70px;" title="Set threshold value directly">
                        <button id="autoThresholdBtn" title="Auto-calculate threshold" style="padding: 2px 8px; font-size: 13px;">Auto</button>
                    </div>
                    <div class="scale-presets" id="scalePresetsContainer">
                        <label>Presets:</label>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-value="0.5" data-desc="Conservative">0.5x</button>
                            <button class="preset-btn" data-value="1.0" data-desc="Standard" class="active">1.0x</button>
                            <button class="preset-btn" data-value="2.0" data-desc="Strict">2.0x</button>
                            <button class="preset-btn" data-value="5.0" data-desc="Very Strict">5.0x</button>
                        </div>
                    </div>
                    <div class="scale-range" id="scaleRangeContainer">
                        <label for="scaleRangeSlider"><span id="scaleRangeLabel">Linear range:</span></label>
                        <div class="slider-container">
                            <input type="range" id="scaleRangeSlider" min="-0.1" max="100" value="20" step="0.1" class="scale-slider">
                            <span class="slider-value" id="scaleMultiplier">1.0x</span>
                        </div>
                    </div>
                    <div class="baseline-flattening" id="baselineFlatteningContainer">
                        <label for="baselineToggle">Baseline:</label>
                        <button class="toggle-btn" id="baselineToggle" data-enabled="false" title="CFX Manager 3.1 style: Flatten non-S-curves only, preserve positive amplification">
                            <span class="toggle-option active">Off</span>
                            <span class="toggle-option">ON</span>
                        </button>
                    </div>
                </div>
            </div>
            </div>

            <div class="results-sections-container">
                <div class="analysis-summary-section">
                    <div class="results-summary">
                        <h3>Analysis Summary</h3>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <span class="stat-label">Experiment Name:</span>
                                <span class="stat-value" id="experimentPattern">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Cycle Range:</span>
                                <span class="stat-value" id="cycleRangeResult">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Total Positive:</span>
                                <span class="stat-value" id="totalPositive">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Positive Percentage:</span>
                                <span class="stat-value" id="positivePercentage">-</span>
                            </div>
                            <div class="control-validation-grid" id="controlValidationGrid" style="display: none;">
                                <div class="control-grid-header">
                                    <span class="control-grid-label">Control Validation:</span>
                                </div>
                                <div class="control-grid">
                                    <div class="control-grid-axis">
                                        <div class="control-grid-corner"></div>
                                        <div class="control-set-header">1</div>
                                        <div class="control-set-header">2</div>
                                        <div class="control-set-header">3</div>
                                        <div class="control-set-header">4</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">H</div>
                                        <div class="control-cell" id="controlH1">-</div>
                                        <div class="control-cell" id="controlH2">-</div>
                                        <div class="control-cell" id="controlH3">-</div>
                                        <div class="control-cell" id="controlH4">-</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">M</div>
                                        <div class="control-cell" id="controlM1">-</div>
                                        <div class="control-cell" id="controlM2">-</div>
                                        <div class="control-cell" id="controlM3">-</div>
                                        <div class="control-cell" id="controlM4">-</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">L</div>
                                        <div class="control-cell" id="controlL1">-</div>
                                        <div class="control-cell" id="controlL2">-</div>
                                        <div class="control-cell" id="controlL3">-</div>
                                        <div class="control-cell" id="controlL4">-</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">NTC</div>
                                        <div class="control-cell" id="controlNTC1">-</div>
                                        <div class="control-cell" id="controlNTC2">-</div>
                                        <div class="control-cell" id="controlNTC3">-</div>
                                        <div class="control-cell" id="controlNTC4">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fluorophore-breakdown" id="fluorophoreBreakdown">
                            <!-- Fluorophore-specific statistics will be populated here -->
                        </div>
                        
                        <!-- Individual pathogen control grids -->
                        <div class="pathogen-control-grids" id="pathogenControlGrids">
                            <!-- Individual 4x4 control grids for each pathogen will be added here -->
                        </div>
                        
                        <!-- Pathogen grids section for new system -->
                        <div id="pathogen-grids-section">
                            <!-- Pathogen-specific control validation grids will be added here -->
                        </div>
                        
                        <div class="channel-completion-status" id="channelCompletionStatus" style="display: none;">
                            <!-- Channel completion status will be populated here -->
                        </div>
                    </div>
                </div>



                <div class="curve-details-section">
                    <div class="curve-details">
                        <h3>Selected Curve Details</h3>
                        <div class="details-content" id="curveDetails">
                            <p>Select a well to view detailed analysis results</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wells-table-container">
                <h3 id="wellsAnalysisTitle">All Wells Analysis</h3>
                <div class="table-controls">
                    <input type="text" id="searchWells" placeholder="Search wells..." class="search-input">
                    <select id="filterStatus" class="filter-select">
                        <option value="all">All Wells</option>
                        <option value="pos">POS Results</option>
                        <option value="neg">NEG Results</option>
                        <option value="redo">REDO Results</option>
                        <option value="controls">Controls</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="resultsTable">
                        <thead>
            <tr>
                <th class="sortable sortable-well" data-sort="well">Well</th>
                <th class="sortable sample-col" data-sort="sample">Sample Name</th>
                <th class="sortable" data-sort="fluorophore">Fluorophore</th>
                <th class="sortable" data-sort="results">Results</th>
                <th class="sortable results-col-curve-class" data-sort="curve-class">Curve Class</th>
                <th class="sortable results-col-status" data-sort="status">Status</th>
                <th class="sortable" data-sort="r2">R¬≤</th>
                <th class="sortable" data-sort="rmse">RMSE</th>
                <th class="sortable" data-sort="amp">Amp</th>
                <th class="sortable" data-sort="steep">Steep</th>
                <th class="sortable" data-sort="mid">Mid</th>
                <th class="sortable" data-sort="base">Base</th>
                <th class="sortable" data-sort="cq">Cq</th>
                <th class="sortable" data-sort="cqj">CQ-J</th>
                <th class="sortable" data-sort="calcj">Calc-J</th>
                <th class="sortable results-col-anom" data-sort="anom">Anom</th>
            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="history-section" id="historySection">
            <div class="history-header">
                <h2>Analysis History</h2>
                <div class="history-controls" style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="control-btn trend-btn" id="trendAnalysisBtn" onclick="viewTrendAnalysis()">View Trends</button>
                    <button class="control-btn delete-btn" id="deleteAllBtn" onclick="deleteAllSessions()" style="background: #e74c3c; color: white;">üóëÔ∏è Delete All</button>
                </div>
            </div>
            
            <div class="history-content" id="historyContent">
                <p>Loading analysis history...</p>
            </div>
        </div>



        <div class="loading" id="loadingIndicator" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing curves...</p>
        </div>

        <!-- Chart Modal -->
        <div class="modal" id="chartModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-navigation">
                        <button class="modal-nav-btn" id="modalPrevBtn" disabled>‚Üê Previous</button>
                        <h3 id="modalTitle">PCR Amplification Curve</h3>
                        <button class="modal-nav-btn" id="modalNextBtn" disabled>Next ‚Üí</button>
                    </div>
                    <span class="modal-close" id="modalClose">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="modal-chart-container">
                        <canvas id="modalChart"></canvas>
                    </div>
                    <div class="modal-details" id="modalDetails">
                        <!-- Sample details will be populated here -->
                    </div>
                    
                    <!-- ML Feedback Section -->
                    <div id="ml-feedback-section" class="ml-feedback-container">
                        <div class="ml-section">
                            <h4>ü§ñ ML Curve Classification</h4>
                            
                            <!-- ML Prediction Display -->
                            <div class="ml-prediction" id="ml-prediction-display" style="display: none;">
                                <div class="prediction-info">
                                    <div class="prediction-result">
                                        <strong>ML Prediction:</strong> 
                                        <span id="ml-prediction-class" class="classification-badge">-</span>
                                        <span id="ml-prediction-confidence" class="confidence-score">-</span>
                                    </div>
                                    <div class="prediction-method">
                                        <small>Method: <span id="ml-prediction-method">-</span></small>
                                    </div>
                                    <div class="pathogen-context" id="pathogen-context" style="display: none;">
                                        <small>üß¨ Pathogen: <span id="detected-pathogen">-</span></small>
                                    </div>
                                </div>
                                
                                <!-- Visual Curve Analysis Display -->
                                <div class="visual-curve-analysis" id="visual-curve-display" style="display: none;">
                                    <h6>üëÅÔ∏è Visual Curve Analysis</h6>
                                    <div class="visual-metrics-grid">
                                        <div class="visual-metric-item">
                                            <span class="metric-label">Curve Shape:</span>
                                            <span id="curve-shape-assessment">-</span>
                                        </div>
                                        <div class="visual-metric-item">
                                            <span class="metric-label">Pattern Type:</span>
                                            <span id="curve-pattern-type">-</span>
                                        </div>
                                        <div class="visual-metric-item">
                                            <span class="metric-label">Visual Quality:</span>
                                            <span id="visual-quality-score">-</span>
                                        </div>
                                        <div class="visual-metric-item">
                                            <span class="metric-label">Similar Patterns:</span>
                                            <span id="similar-patterns-count">-</span>
                                        </div>
                                    </div>
                                    <div class="curve-characteristics">
                                        <div class="characteristic-tags" id="curve-characteristics">
                                            <!-- Dynamic tags for curve characteristics -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Analysis Buttons -->
                            <div class="ml-actions">
                                <button id="ml-analyze-btn" class="ml-btn primary">
                                    üîç Analyze with ML
                                </button>
                                <button id="ml-feedback-btn" class="ml-btn secondary" style="display: none;">
                                    üìù Provide Feedback
                                </button>
                            </div>

                            <!-- Feedback Form -->
                            <div class="ml-feedback-form" id="ml-feedback-form" style="display: none;">
                                <h5>Expert Classification Feedback</h5>
                                <p>Current classification: <span id="current-classification">-</span></p>
                                <p>Help improve the ML model by providing the correct classification:</p>
                                
                                <div class="classification-options">
                                    <label class="classification-option">
                                        <input type="radio" name="expert-classification" value="STRONG_POSITIVE">
                                        <span class="classification-label strong-positive">Strong Positive</span>
                                    </label>
                                    <label class="classification-option">
                                        <input type="radio" name="expert-classification" value="POSITIVE">
                                        <span class="classification-label positive">Positive</span>
                                    </label>
                                    <label class="classification-option">
                                        <input type="radio" name="expert-classification" value="WEAK_POSITIVE">
                                        <span class="classification-label weak-positive">Weak Positive</span>
                                    </label>
                                    <label class="classification-option">
                                        <input type="radio" name="expert-classification" value="INDETERMINATE">
                                        <span class="classification-label indeterminate">Indeterminate</span>
                                    </label>
                                    <label class="classification-option">
                                        <input type="radio" name="expert-classification" value="REDO">
                                        <span class="classification-label redo">Redo</span>
                                    </label>
                                    <label class="classification-option">
                                        <input type="radio" name="expert-classification" value="NEGATIVE">
                                        <span class="classification-label negative">Negative</span>
                                    </label>
                                    <label class="classification-option">
                                        <input type="radio" name="expert-classification" value="SUSPICIOUS">
                                        <span class="classification-label suspicious">Suspicious</span>
                                    </label>
                                </div>

                                <div class="feedback-actions">
                                    <button id="submit-feedback-btn" class="ml-btn primary">
                                        ‚úÖ Submit Feedback
                                    </button>
                                    <button id="cancel-feedback-btn" class="ml-btn secondary">
                                        ‚ùå Cancel
                                    </button>
                                </div>
                            </div>

                            <!-- ML Statistics -->
                            <div class="ml-stats" id="ml-stats-display">
                                <h5>ML Model Status</h5>
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <span class="stat-label">Training Samples:</span>
                                        <span id="stat-training-samples">-</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Model Trained:</span>
                                        <span id="stat-model-trained">-</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Pathogen Models:</span>
                                        <span id="stat-pathogen-models">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <!-- <script src="/static/pathogen_grids_data.js?v=1751381539"></script>-->
    <script>
    // Force CSS reload to bypass cache
    document.addEventListener('DOMContentLoaded', function() {
        const link = document.querySelector('link[rel="stylesheet"]');
        if (link) {
            const newLink = link.cloneNode();
            newLink.href = link.href.split('?')[0] + '?v=' + Date.now();
            link.parentNode.insertBefore(newLink, link.nextSibling);
            link.remove();
        }
    });
    </script>
    <!-- ML Feedback Interface for Curve Classification -->
    <script src="/static/ml_feedback_interface.js?v=1754415484-multichannel-fix" defer></script>
    <script src="/static/script.js?v=1754415484-multichannel-fix" defer></script>    <!-- Initialize ML Feedback Interface -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize ML Feedback Interface after DOM is loaded
        if (typeof MLFeedbackInterface !== 'undefined') {
            console.log('Initializing ML Feedback Interface...');
            window.mlFeedbackInterface = new MLFeedbackInterface();
            console.log('ML Feedback Interface initialized successfully');
        } else {
            console.error('MLFeedbackInterface class not found');
        }
        
        // Check if we came from the queue page
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('fromQueue') === 'true') {
            const queueData = sessionStorage.getItem('queueAnalysisData') || localStorage.getItem('pendingAnalysis');
            if (queueData) {
                try {
                    const data = JSON.parse(queueData);
                    console.log('Loading experiment from queue:', data.experimentId);
                    console.log('Full queue data:', data);
                    
                    // Debug file content availability
                    if (data.amplificationFiles) {
                        console.log('Amplification files count:', data.amplificationFiles.length);
                        data.amplificationFiles.forEach((file, index) => {
                            console.log(`Amplification file ${index}:`, {
                                name: file.name,
                                hasContent: !!file.content,
                                contentLength: file.content ? file.content.length : 0,
                                contentPreview: file.content ? file.content.substring(0, 100) + '...' : 'No content'
                            });
                        });
                    }
                    
                    if (data.summaryFile) {
                        console.log('Summary file:', {
                            name: data.summaryFile.name,
                            hasContent: !!data.summaryFile.content,
                            contentLength: data.summaryFile.content ? data.summaryFile.content.length : 0,
                            contentPreview: data.summaryFile.content ? data.summaryFile.content.substring(0, 100) + '...' : 'No content'
                        });
                    }
                    
                    // Check if we have file content to load directly
                    const hasAmplificationContent = data.amplificationFiles && 
                        data.amplificationFiles.length > 0 && 
                        data.amplificationFiles[0].content && 
                        data.amplificationFiles[0].content.length > 0;
                    
                    const hasSummaryContent = data.summaryFile && 
                        data.summaryFile.content && 
                        data.summaryFile.content.length > 0;
                    
                    console.log('Content analysis:', {
                        hasAmplificationContent,
                        hasSummaryContent,
                        amplificationFilesCount: data.amplificationFiles ? data.amplificationFiles.length : 0
                    });
                    
                    if (hasAmplificationContent) {
                        console.log('Found file content in queue data, loading directly...');
                        
                        // Wait for the page to fully load including uploadManager
                        const loadFiles = () => {
                            console.log('Checking for uploadManager...');
                            
                            // Check multiple possible upload manager references
                            const uploadMgr = window.uploadManager || window.UploadManager || 
                                             (window.script && window.script.uploadManager);
                            
                            // Set a reasonable timeout (10 seconds max)
                            const maxWaitTime = 10000; // 10 seconds
                            const startTime = loadFiles.startTime || Date.now();
                            loadFiles.startTime = startTime;
                            
                            if (!uploadMgr) {
                                const elapsed = Date.now() - startTime;
                                if (elapsed > maxWaitTime) {
                                    console.log('UploadManager not found after 10 seconds, trying alternative file loading methods...');
                                    loadFilesDirectly(data);
                                    return;
                                }
                                
                                console.log(`UploadManager not ready, waiting... (${Math.round(elapsed/1000)}s)`);
                                setTimeout(loadFiles, 500);
                                return;
                            }
                            
                            console.log('UploadManager found! Loading files...');
                            loadFilesViaUploadManager(data, uploadMgr);
                        };
                        
                        // Method to load files via upload manager
                        const loadFilesViaUploadManager = (data, uploadMgr) => {
                            try {
                                // Create File objects from the content
                                const amplificationFiles = data.amplificationFiles.map((fileData, index) => {
                                    console.log(`Creating amplification file ${index + 1}: ${fileData.name}, content length: ${fileData.content.length}`);
                                    const blob = new Blob([fileData.content], { type: 'text/csv' });
                                    const file = new File([blob], fileData.name, {
                                        type: 'text/csv',
                                        lastModified: fileData.lastModified
                                    });
                                    return file;
                                });
                                
                                let summaryFile = null;
                                if (hasSummaryContent) {
                                    console.log(`Creating summary file: ${data.summaryFile.name}, content length: ${data.summaryFile.content.length}`);
                                    const blob = new Blob([data.summaryFile.content], { type: 'text/csv' });
                                    summaryFile = new File([blob], data.summaryFile.name, {
                                        type: 'text/csv',
                                        lastModified: data.summaryFile.lastModified
                                    });
                                }
                                
                                // Load files via upload manager
                                console.log('Loading files via uploadManager...');
                                if (uploadMgr.handleFiles) {
                                    uploadMgr.handleFiles(amplificationFiles, 'amplification');
                                    if (summaryFile) {
                                        uploadMgr.handleFiles([summaryFile], 'summary');
                                    }
                                } else {
                                    throw new Error('UploadManager.handleFiles method not found');
                                }
                                
                                showSuccessNotification(data, amplificationFiles.length, summaryFile ? 1 : 0);
                                autoTriggerAnalysis();
                                
                            } catch (error) {
                                console.error('Error with uploadManager method:', error);
                                loadFilesDirectly(data);
                            }
                        };
                        
                        // Alternative method to load files directly
                        const loadFilesDirectly = (data) => {
                            console.log('Loading files directly via DOM manipulation...');
                            
                            try {
                                // Create File objects
                                const amplificationFiles = data.amplificationFiles.map(fileData => {
                                    const blob = new Blob([fileData.content], { type: 'text/csv' });
                                    return new File([blob], fileData.name, {
                                        type: 'text/csv',
                                        lastModified: fileData.lastModified
                                    });
                                });
                                
                                let summaryFile = null;
                                if (hasSummaryContent) {
                                    const blob = new Blob([data.summaryFile.content], { type: 'text/csv' });
                                    summaryFile = new File([blob], data.summaryFile.name, {
                                        type: 'text/csv',
                                        lastModified: data.summaryFile.lastModified
                                    });
                                }
                                
                                // Direct DOM manipulation approach
                                const fileInput = document.getElementById('fileInput');
                                const samplesInput = document.getElementById('samplesInput');
                                
                                if (fileInput && amplificationFiles.length > 0) {
                                    const dt = new DataTransfer();
                                    amplificationFiles.forEach(file => dt.items.add(file));
                                    fileInput.files = dt.files;
                                    
                                    // Trigger change event
                                    const event = new Event('change', { bubbles: true });
                                    fileInput.dispatchEvent(event);
                                    console.log('Triggered amplification files change event');
                                }
                                
                                if (summaryFile && samplesInput) {
                                    const dt2 = new DataTransfer();
                                    dt2.items.add(summaryFile);
                                    samplesInput.files = dt2.files;
                                    
                                    const event2 = new Event('change', { bubbles: true });
                                    samplesInput.dispatchEvent(event2);
                                    console.log('Triggered summary file change event');
                                }
                                
                                showSuccessNotification(data, amplificationFiles.length, summaryFile ? 1 : 0);
                                autoTriggerAnalysis();
                                
                            } catch (error) {
                                console.error('Error with direct file loading:', error);
                                showFallbackNotification(data);
                            }
                        };
                        
                        // Helper methods
                        const showSuccessNotification = (data, ampCount, summaryCount) => {
                            const notification = document.createElement('div');
                            notification.className = 'alert alert-success alert-dismissible fade show';
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                            notification.innerHTML = `
                                <strong>‚úÖ Queue Files Loaded!</strong><br>
                                Experiment: <strong>${data.experimentId}</strong><br>
                                <small>üìÅ ${ampCount} amplification + ${summaryCount} summary files loaded. Analysis starting automatically...</small>
                                <button type="button" class="close" data-dismiss="alert">
                                    <span>&times;</span>
                                </button>
                            `;
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            }, 8000);
                        };
                        
                        const autoTriggerAnalysis = () => {
                            setTimeout(() => {
                                const analyzeBtn = document.getElementById('analyzeBtn');
                                if (analyzeBtn && !analyzeBtn.disabled) {
                                    console.log('Auto-triggering analysis...');
                                    analyzeBtn.click();
                                } else {
                                    console.log('Analyze button not ready, files loaded for manual analysis');
                                }
                            }, 1500);
                        };
                        
                        // Start loading files
                        setTimeout(loadFiles, 100);
                        
                    } else {
                        console.log('No file content in queue data, showing fallback notification');
                        showFallbackNotification(data);
                    }
                    
                    // Clear the session data
                    sessionStorage.removeItem('queueAnalysisData');
                    localStorage.removeItem('pendingAnalysis');
                    
                } catch (error) {
                    console.error('Error processing queue data:', error);
                }
            }
        }
        
        function showFallbackNotification(data) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-warning alert-dismissible fade show';
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <strong>‚ö†Ô∏è Queue Transfer Issue</strong><br>
                Experiment: <strong>${data.experimentId}</strong><br>
                <small>File content not available. Please re-select files manually or return to queue to re-scan folder.</small>
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 10000);
        }
        
        // ML Batch Analysis for Edge Cases Function
        function triggerMLBatchAnalysisForEdgeCases() {
            console.log('üî¨ Starting ML batch analysis for edge cases...');
            
            // Get edge case wells from the current analysis results
            const edgeCaseWells = [];
            if (window.allResults && window.allResults.individual_results) {
                window.allResults.individual_results.forEach(result => {
                    // Check if this well was marked as an edge case
                    if (result.curve_classification && result.curve_classification.edge_case) {
                        edgeCaseWells.push({
                            well_id: result.well,
                            sample: result.sample,
                            channel: result.fluorophore,
                            pathogen: result.pathogen_code,
                            edge_case_reasons: result.curve_classification.edge_case_reasons,
                            rfu_data: result.rfu_data,
                            cycles: result.cycles,
                            existing_metrics: result.metrics
                        });
                    }
                });
            }
            
            if (edgeCaseWells.length === 0) {
                alert('No edge cases detected in current analysis results.');
                return;
            }
            
            console.log(`üéØ Found ${edgeCaseWells.length} edge cases to analyze`);
            
            // Show progress modal
            const progressModal = document.createElement('div');
            progressModal.className = 'modal fade show';
            progressModal.style.display = 'block';
            progressModal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">üî¨ ML Edge Case Analysis</h5>
                        </div>
                        <div class="modal-body">
                            <p>Analyzing <strong>${edgeCaseWells.length}</strong> edge cases with ML classifier...</p>
                            <div class="progress">
                                <div id="mlProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <p id="mlProgressText" class="mt-2">Preparing analysis...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);
            
            // Process edge cases one by one
            let processedCount = 0;
            const progressBar = progressModal.querySelector('#mlProgressBar');
            const progressText = progressModal.querySelector('#mlProgressText');
            
            function processNextEdgeCase() {
                if (processedCount >= edgeCaseWells.length) {
                    // Analysis complete
                    progressText.textContent = 'Analysis complete! Updating results...';
                    setTimeout(() => {
                        progressModal.remove();
                        alert(`ML analysis completed for ${edgeCaseWells.length} edge cases. Check the results table for updated classifications.`);
                        // Optionally refresh the results table
                        if (typeof refreshAnalysisResults === 'function') {
                            refreshAnalysisResults();
                        }
                    }, 1000);
                    return;
                }
                
                const well = edgeCaseWells[processedCount];
                const progress = Math.round((processedCount / edgeCaseWells.length) * 100);
                progressBar.style.width = progress + '%';
                progressText.textContent = `Analyzing ${well.well_id} (${processedCount + 1}/${edgeCaseWells.length})...`;
                
                // Send ML analysis request
                fetch('/api/ml-predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rfu_data: well.rfu_data,
                        cycles: well.cycles,
                        existing_metrics: well.existing_metrics,
                        pathogen: well.pathogen,
                        well_id: well.well_id,
                        session_id: window.currentSessionId || 'edge_case_batch'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log(`‚úÖ ML analysis completed for ${well.well_id}:`, data);
                    processedCount++;
                    setTimeout(processNextEdgeCase, 500); // Brief delay between requests
                })
                .catch(error => {
                    console.error(`‚ùå ML analysis failed for ${well.well_id}:`, error);
                    processedCount++;
                    setTimeout(processNextEdgeCase, 500); // Continue even if one fails
                });
            }
            
            // Start processing
            processNextEdgeCase();
        }
    });
    </script>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    
</body>
</html>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    
</body>
</html>
