<!DOCTYPE html>
<html>
<head>
    <title>Pattern Extraction Test</title>
    <script src="/static/pathogen_library.js"></script>
    <script src="/static/script.js"></script>
</head>
<body>
    <h1>Pattern Extraction Test</h1>
    <div id="test-results"></div>

    <script>
        // Test function to simulate fresh upload vs session loading scenarios
        function testPatternExtraction() {
            const results = [];
            
            console.log('=== TESTING PATTERN EXTRACTION ===');
            
            // TEST 1: Fresh Upload Scenario
            console.log('\n1. Testing Fresh Upload Scenario:');
            
            // Simulate amplification files like a fresh upload
            window.amplificationFiles = {
                'FAM': {
                    fileName: 'BVPanelPCR1_12345_CFX_FAM.csv',
                    data: 'mock data'
                }
            };
            window.samplesData = null;
            window.currentAnalysisResults = null;
            window.currentSessionFilename = null;
            
            const freshPattern = getCurrentFullPattern();
            console.log(`Fresh upload pattern: "${freshPattern}"`);
            
            // Test pathogen extraction
            const freshTestCode = extractTestCode(freshPattern);
            console.log(`Fresh upload test code: "${freshTestCode}"`);
            
            const freshPathogenName = getPathogenName(freshTestCode);
            console.log(`Fresh upload pathogen name: "${freshPathogenName}"`);
            
            results.push({
                scenario: 'Fresh Upload',
                pattern: freshPattern,
                testCode: freshTestCode,
                pathogenName: freshPathogenName,
                isWorking: freshPattern !== 'Unknown Pattern' && freshTestCode && freshPathogenName !== 'Unknown Pathogen'
            });
            
            // TEST 2: Session Loading Scenario (Before Fix)
            console.log('\n2. Testing Session Loading Scenario (Before Fix):');
            
            // Clear amplification files to simulate session loading
            window.amplificationFiles = {};
            window.samplesData = null;
            window.currentAnalysisResults = null;
            window.currentSessionFilename = null;
            
            const sessionPatternBefore = getCurrentFullPattern();
            console.log(`Session loading pattern (before fix): "${sessionPatternBefore}"`);
            
            const sessionTestCodeBefore = extractTestCode(sessionPatternBefore);
            console.log(`Session loading test code (before fix): "${sessionTestCodeBefore}"`);
            
            const sessionPathogenNameBefore = getPathogenName(sessionTestCodeBefore);
            console.log(`Session loading pathogen name (before fix): "${sessionPathogenNameBefore}"`);
            
            results.push({
                scenario: 'Session Loading (Before Fix)',
                pattern: sessionPatternBefore,
                testCode: sessionTestCodeBefore,
                pathogenName: sessionPathogenNameBefore,
                isWorking: sessionPatternBefore !== 'Unknown Pattern' && sessionTestCodeBefore && sessionPathogenNameBefore !== 'Unknown Pathogen'
            });
            
            // TEST 3: Session Loading Scenario (After Fix)
            console.log('\n3. Testing Session Loading Scenario (After Fix):');
            
            // Simulate session loading with proper filename storage
            window.amplificationFiles = {};
            window.samplesData = null;
            window.currentAnalysisResults = {
                filename: 'BVPanelPCR1_12345_CFX_combined.csv',
                individual_results: {}
            };
            window.currentSessionFilename = 'BVPanelPCR1_12345_CFX_combined.csv';
            
            const sessionPatternAfter = getCurrentFullPattern();
            console.log(`Session loading pattern (after fix): "${sessionPatternAfter}"`);
            
            const sessionTestCodeAfter = extractTestCode(sessionPatternAfter);
            console.log(`Session loading test code (after fix): "${sessionTestCodeAfter}"`);
            
            const sessionPathogenNameAfter = getPathogenName(sessionTestCodeAfter);
            console.log(`Session loading pathogen name (after fix): "${sessionPathogenNameAfter}"`);
            
            results.push({
                scenario: 'Session Loading (After Fix)',
                pattern: sessionPatternAfter,
                testCode: sessionTestCodeAfter,
                pathogenName: sessionPathogenNameAfter,
                isWorking: sessionPatternAfter !== 'Unknown Pattern' && sessionTestCodeAfter && sessionPathogenNameAfter !== 'Unknown Pathogen'
            });
            
            // TEST 4: Test with different pathogen types
            console.log('\n4. Testing Different Pathogen Types:');
            
            const testPathogens = [
                'Lacto_67890_CFX.csv',
                'Ctrach_11111_CFX.csv', 
                'BVPanelPCR3_22222_CFX.csv',
                'Ngon_33333_CFX.csv'
            ];
            
            testPathogens.forEach(filename => {
                window.currentSessionFilename = filename;
                const pattern = getCurrentFullPattern();
                const testCode = extractTestCode(pattern);
                const pathogenName = getPathogenName(testCode);
                
                console.log(`Filename: ${filename} ‚Üí Pattern: "${pattern}" ‚Üí Test Code: "${testCode}" ‚Üí Pathogen: "${pathogenName}"`);
                
                results.push({
                    scenario: `Pathogen Test: ${filename}`,
                    pattern: pattern,
                    testCode: testCode,
                    pathogenName: pathogenName,
                    isWorking: pattern !== 'Unknown Pattern' && testCode && pathogenName !== 'Unknown Pathogen'
                });
            });
            
            return results;
        }
        
        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const results = testPatternExtraction();
            
            // Display results in HTML
            const resultsDiv = document.getElementById('test-results');
            let html = '<h2>Test Results</h2>';
            
            results.forEach(result => {
                const status = result.isWorking ? '‚úÖ WORKING' : '‚ùå BROKEN';
                const statusClass = result.isWorking ? 'working' : 'broken';
                
                html += `
                    <div class="test-result ${statusClass}">
                        <h3>${result.scenario} ${status}</h3>
                        <p><strong>Pattern:</strong> "${result.pattern}"</p>
                        <p><strong>Test Code:</strong> "${result.testCode}"</p>
                        <p><strong>Pathogen Name:</strong> "${result.pathogenName}"</p>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            console.log('\n=== SUMMARY ===');
            const workingCount = results.filter(r => r.isWorking).length;
            const totalCount = results.length;
            console.log(`${workingCount}/${totalCount} tests passing`);
            
            if (workingCount === totalCount) {
                console.log('üéâ ALL TESTS PASSING! Session loading fixes are working.');
            } else {
                console.log('‚ö†Ô∏è Some tests failing. Need further investigation.');
            }
        });
    </script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 15px; border-radius: 5px; }
        .working { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .broken { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        h3 { margin-top: 0; }
    </style>
</body>
</html>
