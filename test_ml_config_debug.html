<!DOCTYPE html>
<html>
<head>
    <title>ML Config Debug Test</title>
</head>
<body>
    <h1>ML Config Debug Test</h1>
    <div id="results"></div>

    <script>
        async function testMLConfigFlow() {
            const results = document.getElementById('results');
            
            // Mock the global functions and data that would exist in the main app
            window.getCurrentFullPattern = function() {
                return 'ACNGON';
            };
            
            window.extractTestCode = function(pattern) {
                if (pattern.startsWith('Ac')) {
                    return pattern.substring(2); // Remove "Ac" prefix
                }
                return pattern;
            };
            
            // Mock well data that would come from the session
            const mockWellData = {
                channel: 'HEX',
                fluorophore: 'HEX',
                fluorescent_channel: 'HEX'
            };
            
            // Simulate extractChannelSpecificPathogen logic
            function extractChannelSpecificPathogen(wellData) {
                const currentExperimentPattern = window.getCurrentFullPattern();
                const testCode = window.extractTestCode(currentExperimentPattern);
                const channel = wellData.channel || wellData.fluorophore || wellData.fluorescent_channel || '';
                
                return {
                    experimentPattern: currentExperimentPattern,
                    test_code: testCode,
                    testCode: testCode,
                    channel: channel || 'Unknown',
                    pathogen: testCode || 'Unknown'
                };
            }
            
            // Simulate shouldHideMLFeedback logic
            async function shouldHideMLFeedback() {
                try {
                    const pathogenInfo = extractChannelSpecificPathogen(mockWellData);
                    results.innerHTML += `<p><strong>Pathogen Info:</strong> ${JSON.stringify(pathogenInfo, null, 2)}</p>`;
                    
                    if (!pathogenInfo.pathogen || pathogenInfo.pathogen === 'Unknown') {
                        results.innerHTML += `<p><em>No pathogen detected, showing ML feedback</em></p>`;
                        return false;
                    }
                    
                    // Get pathogen-specific ML configuration
                    const response = await fetch(`/api/ml-config/pathogen/${encodeURIComponent(pathogenInfo.pathogen)}`);
                    if (!response.ok) {
                        results.innerHTML += `<p><em>Failed to get pathogen config, showing ML feedback</em></p>`;
                        return false;
                    }
                    const configResponse = await response.json();
                    results.innerHTML += `<p><strong>API Response:</strong> ${JSON.stringify(configResponse, null, 2)}</p>`;
                    
                    // Find config for current fluorophore
                    let pathogenMLEnabled = true;
                    if (configResponse.success && configResponse.configs?.length > 0) {
                        const configs = configResponse.configs;
                        
                        // Look for specific fluorophore config first
                        results.innerHTML += `<p><strong>Looking for fluorophore:</strong> "${pathogenInfo.fluorophore}" (note: this is undefined!)</p>`;
                        let config = configs.find(c => c.fluorophore === pathogenInfo.fluorophore);
                        results.innerHTML += `<p><strong>Fluorophore-specific config:</strong> ${JSON.stringify(config, null, 2)}</p>`;
                        
                        // Fall back to general config
                        if (!config) {
                            config = configs.find(c => !c.fluorophore);
                            results.innerHTML += `<p><strong>General config:</strong> ${JSON.stringify(config, null, 2)}</p>`;
                        }
                        
                        // Try looking for channel instead
                        if (!config) {
                            config = configs.find(c => c.fluorophore === pathogenInfo.channel);
                            results.innerHTML += `<p><strong>Channel-based config:</strong> ${JSON.stringify(config, null, 2)}</p>`;
                        }
                        
                        if (config) {
                            pathogenMLEnabled = config.ml_enabled;
                        }
                    }
                    
                    const shouldHide = !pathogenMLEnabled;
                    results.innerHTML += `<p><strong>Final result - ML Enabled:</strong> ${pathogenMLEnabled}, <strong>Should Hide:</strong> ${shouldHide}</p>`;
                    
                    return shouldHide;
                    
                } catch (error) {
                    results.innerHTML += `<p><strong>Error:</strong> ${error.message}</p>`;
                    return false;
                }
            }
            
            // Run the test
            const shouldHide = await shouldHideMLFeedback();
            results.innerHTML += `<h2>ML Modal should be hidden: ${shouldHide}</h2>`;
        }
        
        // Run test when page loads
        window.onload = testMLConfigFlow;
    </script>
</body>
</html>
