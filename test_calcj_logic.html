<!DOCTYPE html>
<html>
<head>
    <title>CalcJ Test - Control Values Verification</title>
    <script src="static/config_manager.js"></script>
    <script src="static/concentration_controls.js"></script>
    <script src="static/cqj_calcj_utils.js"></script>
</head>
<body>
    <h1>CalcJ Verification Test</h1>
    <div id="output"></div>
    
    <script>
        async function testCalcJLogic() {
            const output = document.getElementById('output');
            
            // Wait for config to load
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            output.innerHTML += '<h2>Testing CalcJ Logic</h2>';
            
            // Test 1: Check if CONCENTRATION_CONTROLS is loaded
            const controls = window.CONCENTRATION_CONTROLS || CONCENTRATION_CONTROLS;
            if (controls) {
                output.innerHTML += `<p>✅ CONCENTRATION_CONTROLS loaded with ${Object.keys(controls).length} test configurations</p>`;
                
                // Test 2: Check Cglab FAM controls
                if (controls.Cglab && controls.Cglab.FAM) {
                    const cglabFam = controls.Cglab.FAM;
                    output.innerHTML += `<p>✅ Cglab FAM controls: H=${cglabFam.H}, M=${cglabFam.M}, L=${cglabFam.L}</p>`;
                    
                    // Test 3: Simulate control well CalcJ calculation
                    const mockControlWell = {
                        wellKey: 'A01H',
                        well_id: 'A01H', 
                        sample_name: 'H1',
                        cqj_value: 25.5,
                        fluorophore: 'FAM'
                    };
                    
                    const calcjResult = calculateCalcjWithControls(
                        mockControlWell, 
                        200, 
                        {}, 
                        'Cglab', 
                        'FAM'
                    );
                    
                    output.innerHTML += `<p>✅ Control well (H) CalcJ result: ${calcjResult.calcj_value} (method: ${calcjResult.method})</p>`;
                    
                    if (calcjResult.calcj_value === cglabFam.H) {
                        output.innerHTML += `<p>✅ SUCCESS: Control H gets fixed value ${cglabFam.H}</p>`;
                    } else {
                        output.innerHTML += `<p>❌ FAIL: Control H should get ${cglabFam.H}, got ${calcjResult.calcj_value}</p>`;
                    }
                    
                    // Test 4: Test with different threshold (should still be same fixed value)
                    const calcjResult2 = calculateCalcjWithControls(
                        mockControlWell, 
                        300, // Different threshold
                        {}, 
                        'Cglab', 
                        'FAM'
                    );
                    
                    output.innerHTML += `<p>✅ Control H with different threshold: ${calcjResult2.calcj_value} (method: ${calcjResult2.method})</p>`;
                    
                    if (calcjResult2.calcj_value === cglabFam.H) {
                        output.innerHTML += `<p>✅ SUCCESS: Control CalcJ remains constant regardless of threshold</p>`;
                    } else {
                        output.innerHTML += `<p>❌ FAIL: Control CalcJ should remain constant</p>`;
                    }
                    
                } else {
                    output.innerHTML += '<p>❌ Cglab FAM controls not found</p>';
                }
            } else {
                output.innerHTML += '<p>❌ CONCENTRATION_CONTROLS not loaded</p>';
            }
        }
        
        // Run test when page loads
        window.addEventListener('load', () => {
            setTimeout(testCalcJLogic, 2000); // Wait for config loading
        });
    </script>
</body>
</html>
