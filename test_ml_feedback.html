<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test ML Feedback Interface</title>
    <script src="static/pathogen_library.js"></script>
    <script src="static/ml_feedback_interface.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; }
    </style>
</head>
<body>
    <h1>ML Feedback Interface Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Check Enabled Pathogens</h2>
        <button onclick="testEnabledPathogens()">Test Enabled Pathogens API</button>
        <div id="enabled-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Check ML Feedback Interface Creation</h2>
        <button onclick="testMLInterface()">Create ML Interface</button>
        <div id="interface-result" class="result"></div>
        <div id="ml-modal-container"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Check Pathogen Library</h2>
        <button onclick="testPathogenLibrary()">Test Pathogen Library</button>
        <div id="pathogen-result" class="result"></div>
    </div>

    <script>
        // Test enabled pathogens API
        async function testEnabledPathogens() {
            const resultDiv = document.getElementById('enabled-result');
            try {
                const response = await fetch('/api/ml-config/enabled-pathogens');
                const data = await response.json();
                
                if (data.success && data.enabled_pathogens) {
                    const pathogens = Object.keys(data.enabled_pathogens);
                    resultDiv.innerHTML = `
                        <strong>✅ API Working!</strong><br>
                        Found ${pathogens.length} enabled pathogens:<br>
                        <ul>
                            ${pathogens.slice(0, 10).map(p => `<li>${p}: ${data.enabled_pathogens[p].join(', ')}</li>`).join('')}
                            ${pathogens.length > 10 ? '<li>... and more</li>' : ''}
                        </ul>
                        MGEN enabled: ${pathogens.includes('Mgen') ? '✅ YES' : '❌ NO'}<br>
                        Ctrop enabled: ${pathogens.includes('Ctrop') ? '✅ YES' : '❌ NO'}
                    `;
                } else {
                    resultDiv.innerHTML = `❌ API Error: ${JSON.stringify(data)}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ Fetch Error: ${error.message}`;
            }
        }

        // Test ML interface creation
        function testMLInterface() {
            const resultDiv = document.getElementById('interface-result');
            const container = document.getElementById('ml-modal-container');
            
            try {
                // Create a mock modal structure
                container.innerHTML = `
                    <div id="sampleModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-body">
                                <div id="modal-sample-info">
                                    <p>Test Well: A1</p>
                                    <p>Channel: FAM</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Create ML feedback interface
                const mlInterface = new MLFeedbackInterface();
                
                // Check if interface was created
                const mlSection = document.getElementById('ml-feedback-section');
                if (mlSection) {
                    resultDiv.innerHTML = `
                        ✅ ML Interface Created Successfully!<br>
                        ML Section exists: ${mlSection ? 'YES' : 'NO'}<br>
                        Feedback button exists: ${document.getElementById('ml-feedback-btn') ? 'YES' : 'NO'}<br>
                        Feedback form exists: ${document.getElementById('ml-feedback-form') ? 'YES' : 'NO'}
                    `;
                } else {
                    resultDiv.innerHTML = `❌ ML Interface creation failed - no ML section found`;
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ Interface Error: ${error.message}`;
            }
        }

        // Test pathogen library
        function testPathogenLibrary() {
            const resultDiv = document.getElementById('pathogen-result');
            
            try {
                // Check if pathogen library functions exist
                const hasExtractTestCode = typeof extractTestCode === 'function';
                const hasGetPathogenTarget = typeof getPathogenTarget === 'function';
                
                let result = `
                    extractTestCode function: ${hasExtractTestCode ? '✅ YES' : '❌ NO'}<br>
                    getPathogenTarget function: ${hasGetPathogenTarget ? '✅ YES' : '❌ NO'}<br>
                `;

                if (hasExtractTestCode && hasGetPathogenTarget) {
                    // Test with MGEN
                    try {
                        const mgenTarget = getPathogenTarget('Mgen', 'FAM');
                        result += `MGEN target for FAM: ${mgenTarget}<br>`;
                    } catch (e) {
                        result += `MGEN target error: ${e.message}<br>`;
                    }

                    // Test with Ctrop
                    try {
                        const ctropTarget = getPathogenTarget('Ctrop', 'FAM');
                        result += `Ctrop target for FAM: ${ctropTarget}<br>`;
                    } catch (e) {
                        result += `Ctrop target error: ${e.message}<br>`;
                    }
                }

                resultDiv.innerHTML = result;
            } catch (error) {
                resultDiv.innerHTML = `❌ Pathogen Library Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
